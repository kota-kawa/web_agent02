services:
  browser-agent:
    build:
      context: .
      dockerfile: Dockerfile.flask
    env_file:
      - secrets.env
    ports:
      - '5005:5005'
    environment:
      - EMBED_BROWSER_URL=http://127.0.0.1:7900/vnc_lite.html?autoconnect=1&resize=scale&scale=auto&view_clip=false
    depends_on:
      - browser
    networks:
      - default
      - multi_agent_network

  browser:
    build:
      context: .
      dockerfile: Dockerfile.chrome
    shm_size: 2gb
    ports:
      - '4444:4444'
      - '7900:7901'
    environment:
      - NO_VNC_PORT=7901
      - SE_VNC_NO_PASSWORD=1
      - SE_SCREEN_WIDTH=2560
      - SE_SCREEN_HEIGHT=1440
      - SE_NODE_OVERRIDE_CAPABILITIES={"browserName":"chrome","platformName":"linux","goog:chromeOptions":{"args":["--start-maximized"]}}
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:4444/status || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    extra_hosts:
      - "localhost:host-gateway"
    networks:
      - default
      - multi_agent_network

networks:
  multi_agent_network:
    external: true
    name: ${MULTI_AGENT_NETWORK:-multi_agent_platform_net}
