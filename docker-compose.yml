version: '3.9'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.flask
    env_file:
      - secrets.env
    ports:
      - '5005:5005'
    environment:
      - EMBED_BROWSER_URL=http://127.0.0.1:7900/vnc_lite.html?autoconnect=1&resize=scale&scale=auto&view_clip=false
      - BROWSER_WINDOW_WIDTH=3840
      - BROWSER_WINDOW_HEIGHT=1080
    depends_on:
      - browser
    networks:
      - default
      - multi_agent_network

  browser:
    image: selenium/standalone-chrome:latest
    shm_size: 2gb
    ports:
      - '4444:4444'
      - '7900:7900'
    environment:
      - SE_VNC_NO_PASSWORD=1
      - SE_SCREEN_WIDTH=3840
      - SE_SCREEN_HEIGHT=1080
      - SE_NODE_OVERRIDE_CAPABILITIES={"browserName":"chrome","platformName":"linux","goog:chromeOptions":{"args":["--start-maximized"]}}
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:4444/status || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - default
      - multi_agent_network

networks:
  multi_agent_network:
    external: true
    name: ${MULTI_AGENT_NETWORK:-multi_agent_platform_net}
